---
title: "区間推定と検出力分析"
author: "秋山海登"
date: "2025-1-16"
format:
  revealjs: 
    width: 1600
    height: 900
    theme: default
    slide-number: true
    chalkboard: 
      buttons: false
    preview-links: auto
    css: styles.css
    transition: slide
    incremental: false  # デフォルトでインクリメンタルをオフに
    mainfont: "Hiragino Kaku Gothic ProN"
    monofont: "Hiragino Kaku Gothic ProN"
    hash: true
    center: true
    show-notes: false
    pdf-separate-fragments: false  # フラグメントごとのPDF分割を防ぐ
---

## 自己紹介
- 好きな物：
  - 飲み物：コカ・コーラ
  - 食べ物：チョコレート
  - 動物：鳥類（特にオウムやフクロウ）
  
- 苦手なこと：
  - ベッドから動くこと
  - じっとしてること

## 本授業の内容
- 前半（75分）：統計的推定
  - 点推定
  - 区間推定
  - 演習1：区間推定の実践
  - シミュレーションによる区間推定の検証

- 後半（75分）：統計的検定
  - 統計的検定の誤り
  - 再現性の問題
  - 検出力分析
  - 演習2：検出力分析の実践
  - シミュレーションによる検出力分析の検証
  - 課題の説明

::: {.footer}
資料作成方法：Quarto + RMarkdown
:::

```{r setup, include=FALSE}
# 必要なライブラリの読み込み
library(tidyverse) 
library(knitr)
library(rmarkdown)
library(magrittr)
library(kableExtra)
# knitrのオプション設定
opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)
# ggplot2の日本語フォント設定を修正
theme_set(theme_minimal(base_family = "HiraginoSans-W3"))  # MacOS用の日本語フォント
```

# 問題提起
身近な疑問から統計的推論へ

## 日常生活における疑問

例：「**睡眠時間と集中力**って，本当に相関があるのかな？」

- 多くの人が，睡眠不足だと集中力が落ちると感じている

例：「**朝食を食べる習慣**は，学力に影響するんだろうか？」

- 朝食を食べた方が良いと聞くけれど，本当に効果があるのか？

::: {.notes}
1. スマホアプリで続けやすくなる？
スマホのチャットボットを使うと，習い事やトレーニングを最後まで続けやすくなるのか？
2. LINEのメッセージがやる気をアップ？
LINEなどのメッセージを送ってくれるキャラクターがいると，やるべきことを続けやすくなるのか？
3. 忙しくても勉強を続けられる方法は？
忙しい日々の中でも，自分を励ましてくれるアプリを使うと勉強を続けやすくなるのか？
4. チャットでモチベーションを保てる？
何かを学んだり取り組むときに，毎日応援メッセージを送ってくれるアプリがあるとやる気を保てるのか？
5. やる気がないとき，アプリで助けてもらえる？
やる気が出ないときに優しい言葉をかけてくれるアプリが，本当に役立つのか？
6. 習慣を身につけるには？
自分に合った励ましをしてくれるアプリを使うと，新しい習慣を続けられるようになるのか？
7. 途中でやめるのを防ぐ方法は？
チャットボットを使って「三日坊主」を防ぐことができるのか？
8. 自分専用の応援キャラは効果的？
自分専用の応援キャラクターがいると，毎日の取り組みを続けられるようになるのか？
9. メッセージが届くとやる気になる？
毎日決まった時間に応援メッセージが届くと，モチベーションを上げてくれるのか？
10. 一人でやるよりもアプリを使った方がいい？
一人で黙々とやるより，応援してくれるアプリを使った方が続けやすいのか？
:::

# 統計的推論 {background="#43464B"}
主観的な判断からデータによる判断へ

# 統計的推定 {background="#43464B"}
得られたデータから母数を推定する

## 統計的推定とは？
- 母数（母集団における代表値）を，標本（実際に得られたデータ）から推測すること
  - 例：
    - 母平均 (*μ*): 母集団における測定値の平均
    - 母相関係数 (*ρ*): 母集団における2変数間の相関係数
- 母数は，通常，**未知**であるため，標本から推定する必要がある
  - 母数の測定が現実的に困難であるため
- 推定の方法には，点推定と区間推定がある

## 点推定

- 母数（母集団における代表値）を，標本（実際に得られたデータ）から推測すること
- 母数は通常未知であるため，標本から推定する必要がある
- 推定の方法には，点推定と区間推定がある


---

## 最尤法 (Maximum Likelihood Estimation: MLE)
- 「データが最も起こりやすい値」を推定値とする方法
- データの生起確率を最大化する母数を求める
- 例：成功確率が未知のコインを5回投げたところ，表が3回出た。
  - この場合，コインの表が出る確率を *θ* とし，最尤法ではその推定値を 3/5 とする
  - このデータ（表3回，裏2回）が生じる確率が，*θ* = 3/5 の時に最大になるため
- 特徴：分布の仮定が必要
  - 上記の例では，コイン投げの結果はベルヌーイ分布に従うと仮定している。
  - ベルヌーイ分布は，成功確率 *θ* を持つ試行の結果が成功か失敗かの2値である確率分布


---

## 最小二乗法 (Least Squares Method: LSM)
- 「観測値と予測値の差（残差）の二乗和を最小にする値」を推定値とする方法
- 各データ点から予測値までの距離の二乗和を最小化
- 例：回帰分析で，データ点から回帰直線までの垂直距離の二乗和が最小となるような直線を引く
- 特徴：分布の仮定は不要な場合が多い。ただし，統計的仮説検定には誤差項の分布に関する仮定が必要になる場合もある。


---

## 最尤法と最小二乗法の比較

| 項目          | 最尤法 (MLE)                               | 最小二乗法 (LSM)                             |
|---------------|-------------------------------------------|--------------------------------------------|
| 推定方法      | データの生起確率を最大化する母数を求める     | 残差の二乗和を最小化する値を求める           |
| 分布の仮定    | 必要                                      | 不要な場合が多い                              |
| 計算の複雑さ | 複雑になる場合がある                         | 比較的単純                                   |
| 適用例        | コイン投げ，ポアソン分布に従うデータなど     | 線形回帰分析，多項式回帰分析など             |
| 類似点        | 状況によっては同じ結果を与える               |                                            |
| 相違点        | 分布の仮定が必要，計算が複雑になる場合がある | 分布の仮定が不要な場合が多い，計算が比較的単純 |


## 区間推定 (Interval Estimation)
- 定義：母数（例：母集団平均）を，範囲で推測する方法
  - 例：「大学生の平均睡眠時間は6.5時間から7.2時間の間にある」

- 信頼区間 (Confidence Interval: CI)：
  - 推定値の不確実性を考慮した範囲

- 信頼水準 (Confidence Level)：
  - 信頼区間が母数を含む確率 (例：95%, 99%)
  - 一般的に95%を使用される
  - 信頼水準が高くなるほど，区間幅は広くなる

## 研究例：抑うつへのオンラインCBTの効果

- オンラインCBTプログラムの効果検証
- 対象者数: 149名（完了142名）
- 平均年齢: 41.4歳（SD=11.1）
- 対象：軽度抑うつ症状のある会社員


::: {.footer}
[Yasukawa et al. (2024). BMJ Mental Health](https://doi.org/10.1136/bmjment-2023-300881)
:::

## 信頼区間を数直線上でイメージ

- 抑うつ症状（CES-D）の変化量
- 95%信頼区間: [-5.2, -2.1]
  ```{r}
  #| echo: false
  #| fig-width: 6
  #| fig-height: 2
  library(ggplot2)
  ggplot() +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_errorbarh(aes(y = 1, xmin = -5.2, xmax = -2.1, height = 0.2)) +
    geom_point(aes(x = -3.65, y = 1), size = 3) +
    scale_x_continuous(limits = c(-6, 1)) +
    theme_minimal(base_family = "HiraginoSans-W3") +  # テーマのフォント設定を追加
    labs(x = "CES-D得点の変化", y = "")
  ```
:::

::: {.footer}
[Yasukawa et al. (2024). BMJ Mental Health](https://doi.org/10.1136/bmjment-2023-300881)
:::

::: {.notes}
- 信頼区間は「点推定値±誤差の範囲」を示す
- 95%信頼区間は，同様の研究を100回実施した場合，95回はこの区間内に真の値が含まれることを意味する
- 区間の幅は推定の精度を反映（狭いほど精度が高い）
:::



# 演習1 {background="#43464B"}
実際のデータを使って仮説検定を行う

## データの概要
### 使用データ
- **研究名**: 「Webベースのポジティブ心理学的介入：効果の再検証」
- **著者**: Woodworth, R. J., et al. (2018)
- **出典**: Journal of Open Psychology Data, 6: 1
- **DOI**: https://doi.org/10.5334/jopd.35

### 目的
- ポジティブ心理学介入の長期的効果の検証
- 実際の研究における統計的検定の活用方法の学習

### 特徴
- オープンデータとして公開

::: {.notes}
このデータセットを使用することで，実際の研究データを用いた統計的検定の手順と解釈を学ぶことができます。
:::

# 当該研究の説明 {background="#43464B" background-image="images/サイトの見た目.png" background-opacity="0.3"}

## 研究背景
- Seligman et al. (2005)のポジティブ心理学介入に関する研究は，幸福感の向上と抑うつの軽減に効果がある可能性を示唆した。
- Woodworth et al. (2017)は，先行研究を追試する研究を行ったが，有意な効果は確認されず，ポジティブ心理学的介入の効果を再検討する必要性が示唆された。

## 研究目的
- Webベースのポジティブ心理学的介入が，幸福感と抑うつに及ぼす効果の検証
- 質問紙尺度を用いて，介入前後，そして6ヶ月までの追跡期間で測定
- 異なる介入条件間の効果を比較検討する。

## 参加者
- 一般参加者 295名

## 測定時期
- ベースライン(0)
- 介入直後(1)
- 1週間後(2)
- 1ヶ月後(3)
- 3ヶ月後(4)
- 6ヶ月後(5)

## 測定指標
- AHI: Authentic Happiness Inventory (24項目)
  - 幸福感を測定する尺度で，過去1週間の感情について5件法で回答
  - 合計スコアは24-120の範囲

- CES-D: Center for Epidemiological Studies Depression scale (20項目)
  - 抑うつ症状を測定する尺度で，過去1週間の症状について4件法で回答
  - 合計スコアは0-60の範囲

::: {.notes}
参加者を4つのグループ（介入条件）に無作為割付
割付は，ウェブサイトの自動化システムにより実施
全ての測定は同一の尺度を使用
AHI, CES-Dともに同一の項目で測定
長期的な追跡デザイン (6ヶ月間)
介入の効果が，時間の経過とともにどのように変化するかを調査
参加者のIPアドレスを確認し，オーストラリア国内からの参加であることを確認
介入後の調査において，各参加者に指定された介入活動を行ったかを確認
本研究はタスマニア社会科学研究倫理委員会によって承認されている (Tasmanian Social Sciences Research Ethics Committee)
:::

# Rでの分析 

## データの読み込み
```{r setup-data}
#| echo: true
ahi_cesd <- read.csv("data/ahicesd.csv") # データの読み込み
```
- Woodworth et al.(2018)のデータにアクセスして，ファイルをダウンロードして開く。作成したプロジェクト内のdataフォルダ内にahi-cesd.csvを配置する。
- データの格納場所：プロジェクトの`data`フォルダ内
- データはcsv形式なので，read.csv()で読み込む。

## データの確認

::: {.columns}

::: {.column width="60%"}
![](images/データ確認3.webp)
:::

::: {.column width="40%"}
以下の変数がある：

- id: 参加者ID
- occasion: 測定時点
- elapsed.days: 経過日数 
- intervention: 介入条件
- ahi01~: AHI（幸福感）の項目
- cesd01~: CES-D（抑うつ）の項目
:::

:::

::: {.notes}
- データフレームの形式で整理されています
- 縦方向に各参加者のデータが並び，横方向に変数が配置されています
- 欠損値は NA として記録されています
:::

## 演習1におけるリサーチクエスチョン
  「幸福感と抑うつは，どの程度の負の相関を示すのだろうか？」

  - 直感的には，幸福な人は抑うつ傾向が低く，抑うつ傾向の強い人は幸福感が低いと考えられる
  - しかし，それはどの程度の相関を示すのだろうか？
  - **区間推定**を行うことで検証可能
  - 演習1は**ベースライン時点（介入前）のデータのみ**を使用する

## 相関分析
### 目的
- 幸福感と抑うつの相関係数を推定する

### 内容
- ベースライン時点（介入前）のデータのみを使用
- 95%信頼区間と99%信頼区間を算出

## 相関分析の実行
```{r correlation}
#| echo: true
#| warning: false
#| message: false
baseline_data <- subset(ahi_cesd, occasion == 0)  # ベースライン（occasion = 0）のデータのみを抽出
baseline_scores <- baseline_data[, c("ahiTotal", "cesdTotal")] # 分析に必要な変数（AHIとCES-Dの得点）のみを選択
# 95%信頼区間
correlation_result_95 <- cor.test(# 結果をオブジェクトとして格納
  x = baseline_scores$ahiTotal,    # 幸福感得点
  y = baseline_scores$cesdTotal,   # 抑うつ得点
  method = "pearson",              # ピアソンの相関係数を使用
  alternative = "two.sided")
# 99%信頼区間
correlation_result_99 <- cor.test( # 結果をオブジェクトとして格納
  x = baseline_scores$ahiTotal,    # 幸福感得点
  y = baseline_scores$cesdTotal,   # 抑うつ得点
  method = "pearson",              # ピアソンの相関係数を使用
  alternative = "two.sided",
  conf.level = 0.99)
```

## print関数で結果の表示
```{r}
#| echo: true
#| warning: false
#| message: false
print(correlation_result_95)
print(correlation_result_99)
```

::: {.footer}
print関数では，結果の表示ができる
:::


::: {.notes}
統計的有意性: p値は 2.2e-16 未満であり，これは非常に小さい値です (0.00000000000000022)。 これは，幸福感と抑うつ間に無相関であるという帰無仮説を棄却するのに十分な証拠であり，観測された相関は統計的に有意であることを示しています。
95%信頼区間: 幸福感と抑うつ間の相関係数の 95% 信頼区間は [-0.775, -0.666] でした。この区間は完全に負の値であり，母集団においても負の相関が存在する可能性が高いことを示唆しています。
99%信頼区間: さらに高い確信度である 99% 信頼区間は [-0.789, -0.646] でした。これも完全に負の値であり，95%信頼区間と同様に母集団における負の相関関係を強く支持する結果です。 99%信頼区間の方が幅が広いのは，より高い確信度を得るためにより広い範囲を考慮しているためです。
:::

## なぜオブジェクトに格納するのか？
   - 一度の分析結果を複数回利用可能
   ```r
   # 相関係数だけ表示
   correlation_result_95$estimate
   # p値だけ表示
   correlation_result_95$p.value
   # 信頼区間だけ表示
   correlation_result_95$conf.int
   ```

   - 分析結果に意味のある名前をつけてコードの意図を明確化
   ```r
   長村に頼まれた分析 <- correlation_result_95
   ```

   - 結果を他の分析や可視化に利用可能
   ```r
   ggplot() +
     geom_point() +
     geom_smooth(method = "lm") +
     ggtitle(paste("相関係数:", 
             round(correlation_result_95$estimate, 3)))
   ```

::: {.footer}
オブジェクトに格納することで，分析結果を効率的に管理・活用できる
:::

## 結果の解釈
相関係数は *r* = -.73 であり，強い負の相関が見られた

- *p*値は 2.2e-16より小さく，統計的に有意である
  - 帰無仮説は棄却される
  - 2.2e-16 = .00000000000000022
- 95%信頼区間は [-.78, -.67] 
- 99%信頼区間は [-.79, -.65] 
- 99%信頼区間の方が95%信頼区間よりも幅が広い

::: {.footer}
「e」は「10の何乗」を意味し，「-16」は「10を16回小さい方に掛ける」という意味
:::

::: {.notes}
相関分析の結果について詳しく説明します：

1. 相関係数の解釈
- *r* = -.73は強い負の相関を示しています
- これは幸福感が高いほど抑うつ傾向が低く，逆に幸福感が低いほど抑うつ傾向が高いことを意味します

1. 統計的有意性
- *p*値（2.2e-16）は0.00000000000000022という極めて小さい値
- 一般的な有意水準（α = .05 ）と比べても，はるかに小さい値
- 「e」 は「10の何乗」という意味
- 「-16」 は「10を16回小さい方に掛ける（つまり分母に置く）」という意味

1. 信頼区間の意味
- 95%信頼区間が全て負の値（-0.78から-0.67）であることは，母集団でも確実に負の相関があることを示唆しています
- 区間の幅が比較的狭いことは，推定の精度が高いことを意味します
:::

## 正規分布を用いた95%信頼区間と有意水準の解釈
```{r ci-plot}
#| echo: false
#| fig-width: 17
#| fig-height: 7

# 相関係数の分布を描画
r_range <- seq(-1, 1, length.out = 200)
n <- nrow(baseline_scores) # サンプルサイズ
z <- 0.5 * log((1 + r_range)/(1 - r_range)) # Fisher's z変換
se <- 1/sqrt(n - 3) # 標準誤差
density <- dnorm(z, 0, se) * (1 - r_range^2)

# データフレームの作成
plot_data <- data.frame(r = r_range, density = density)

# 有意水準5%に対応する相関係数の臨界値を計算
critical_z_95 <- qnorm(0.975) # 両側5%の場合は97.5%点を使用
critical_r_95 <- (exp(2 * critical_z_95 * se) - 1)/(exp(2 * critical_z_95 * se) + 1)

# 有意水準1%に対応する相関係数の臨界値を計算
critical_z_99 <- qnorm(0.995) # 両側1%の場合は99.5%点を使用
critical_r_99 <- (exp(2 * critical_z_99 * se) - 1)/(exp(2 * critical_z_99 * se) + 1)

# プロット作成
ggplot(plot_data, aes(x = r, y = density)) +
  # 正規分布全体を薄い青で塗りつぶし
  geom_area(aes(y = density), fill = "lightblue", alpha = 0.2) +
  # メインの曲線
  geom_line(linewidth = 1, color = "steelblue") +
  # 95%有意水準の境界を点線で表示
  geom_vline(xintercept = c(-critical_r_95, critical_r_95),
             linetype = "dotted",
             color = "red",
             linewidth = 1) +
  # 99%有意水準の境界を点線で表示
  geom_vline(xintercept = c(-critical_r_99, critical_r_99),
             linetype = "dotted",
             color = "purple",
             linewidth = 1) +
  # 95%信頼区間の境界を破線で表示
  geom_vline(xintercept = c(-0.78, -0.67),
             linetype = "dashed",
             color = "blue",
             linewidth = 1) +
  # 99%信頼区間の境界を破線で表示
  geom_vline(xintercept = c(-0.79, -0.65),
             linetype = "dashed",
             color = "green",
             linewidth = 1) +
  # 推定値の位置
  geom_vline(xintercept = -0.73,
             color = "darkgreen",
             linewidth = 1) +
  # アノテーション
  annotate("text", x = -0.45, y = max(plot_data$density) * 0.9,
           label = "推定値\nr = -0.73",
           color = "darkgreen",
           size = 10,
           family = "HiraginoSans-W3") +
  annotate("text", x = -0.45, y = max(plot_data$density) * 0.5,
           label = "95%信頼区間\n[-0.78, -0.67]",
           color = "blue",
           size = 10,
           family = "HiraginoSans-W3") +
  annotate("text", x = -0.45, y = max(plot_data$density) * 0.3,
           label = "99%信頼区間\n[-0.79, -0.65]",
           color = "green",
           size = 10,
           family = "HiraginoSans-W3") +
  annotate("text", x = 0.5, y = max(plot_data$density) * 0.3,
           label = "有意水準 5%\n(棄却域)",
           color = "red",
           size = 10,
           family = "HiraginoSans-W3") +
  annotate("text", x = 0.5, y = max(plot_data$density) * 0.1,
           label = "有意水準 1%\n(棄却域)",
           color = "purple",
           size = 10,
           family = "HiraginoSans-W3") +
  # ラベルとテーマ
  labs(
    title = "母相関係数の95%と99%信頼区間と有意水準",
    x = "相関係数",
    y = "確率密度"
  ) +
  theme_minimal(base_family = "HiraginoSans-W3") +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 20)
  )
```

## 散布図
```{r correlation-plot}
#| echo: false

# 散布図の作成
ggplot(baseline_scores, aes(x = ahiTotal, y = cesdTotal)) +
  # 散布図のポイントを描画（透明度0.5）
  geom_point(alpha = 0.5) +
  # 95%信頼区間の回帰直線を追加
  geom_smooth(method = "lm", se = TRUE, color = "red", fill = "red", alpha = 0.2) +
  # 99%信頼区間の回帰直線を追加
  geom_smooth(method = "lm", se = TRUE, level = 0.99, color = "blue", fill = "blue", alpha = 0.1) +
  # ラベルの設定
  labs(
    x = "AHI総得点",
    y = "CES-D総得点",
    caption = "注：赤の帯は95%信頼区間、青の帯は99%信頼区間を表す"
  ) +
  theme_minimal(base_size = 15, base_family = "HiraginoSans-W3") +  # 日本語フォントを指定
  theme(
    plot.title = element_text(size = 18,
    face = "bold",
    family = "HiraginoSans-W3"),
    axis.title = element_text(size = 16,
    family = "HiraginoSans-W3"),
    axis.text = element_text(size = 14,
    family = "HiraginoSans-W3")
  )
```

## 信頼区間のシミュレーションコード
```{r ci-simulation-code}
#| echo: true
n_sims <- 1000      # シミュレーション回数を定義
sample_size <- 30   # サンプルサイズ
true_cor <- cor(baseline_data$ahiTotal, baseline_data$cesdTotal)  # 母相関係数
# 結果格納用のデータフレーム作成
results <- data.frame(
  sim_number = 1:n_sims,
  estimate = numeric(n_sims),
  ci_lower = numeric(n_sims),
  ci_upper = numeric(n_sims),
  contains_true = logical(n_sims)
)
set.seed(123)  # 再現性のために乱数シードを固定
for(i in 1:n_sims) {
  # 無作為抽出とデータ分析
  sample_data <- baseline_data[sample(1:nrow(baseline_data), 
                                    sample_size, replace = TRUE), ]
  test_result <- cor.test(sample_data$ahiTotal, sample_data$cesdTotal)
  
  # 結果の記録
  results[i, 2:5] <- c(test_result$estimate,
                       test_result$conf.int,
                       between(true_cor, test_result$conf.int[1], 
                              test_result$conf.int[2]))
}
```

## シミュレーション結果の可視化
```{r ci-simulation-plot}
#| echo: false
#| fig.width: 17
#| fig.height: 7

# 母数を含む区間の割合を計算
coverage_rate <- mean(results$contains_true) * 100

# 結果のプロット
ggplot(results[1:100,], aes(x = sim_number)) + 
  # 信頼区間を線分で表示
  geom_linerange(aes(ymin = ci_lower, ymax = ci_upper,
                     color = factor(contains_true)), # factorに変換
                 alpha = 0.5) +
  # 推定値を点で表示
  geom_point(aes(y = estimate), size = 1) +
  # 真の値を水平線で表示
  geom_hline(yintercept = true_cor, 
             linetype = "dashed", 
             color = "red", 
             linewidth = 1) +
  # 色の設定
  scale_color_manual(values = c("red", "blue"),
                    labels = c("母数を含まない区間", "母数を含む区間")) +
  # ラベルの設定
  labs(title = "95%信頼区間のシミュレーション結果（最初の100回分）",
       subtitle = sprintf("母数を含む区間の割合: %.1f%% (全%d回中)", 
                         mean(results$contains_true) * 100, n_sims),
       x = "シミュレーション回数",
       y = "相関係数",
       color = "信頼区間の評価") +
  # テーマの設定
  theme_minimal(base_family = "HiraginoSans-W3") +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 16),
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 20),
    legend.text = element_text(size = 16),
    legend.title = element_text(size = 16),
    legend.position = "bottom"
  )
```

## シミュレーション結果の解釈

:::: {.columns}

::: {.column width="50%"}
### 図の見方
- 縦の線：各試行での95%信頼区間
- 点：推定された相関係数
- 赤い破線：母集団の真の相関係数
- 青い区間：母数を含む信頼区間
- 赤い区間：母数を含まない信頼区間
:::

::: {.column width="50%"}
### 重要な発見
- 約95%の信頼区間が母数を含む
- 区間の幅は試行ごとに異なる
- 推定値は真の値の周りでばらつく
- 理論値（95%）と実測値が近い
:::

::::
## シミュレーション結果の解釈

:::: {.columns}

::: {.column width="50%"}
### 図の見方
- 縦の線：各試行での95%信頼区間
- 点：推定された相関係数
- 赤い破線：母集団の真の相関係数
- 青い区間：母数を含む信頼区間
- 赤い区間：母数を含まない信頼区間
:::

::: {.column width="50%"}
### 重要な発見
- 約95%の信頼区間が母数を含む
- 区間の幅は試行ごとに異なる
- 推定値は真の値の周りでばらつく
- 理論値（95%）と実測値が近い
:::

::::

::: {.notes}
このシミュレーションでは：
1. 母集団から30名をランダムに抽出
2. 相関係数と95%信頼区間を計算
3. これを1000回繰り返す
4. 各信頼区間が母数を含むかチェック
5. 結果を視覚化して表示

見やすさのため，プロットでは最初の100回分のみを表示していますが，
カバレッジ確率（母数を含む区間の割合）は1000回全ての試行から計算しています。
:::



# 後半 {background="#43464B"}
統計的仮説検定

## 統計的仮説検定とは？
- 標本データに基づき，観察された差や関係性が統計的に意味があるか判断する

### 研究例：オンラインCBTはうつ症状を改善するか？
  - 介入群：オンラインCBTを実施（20名）
  - 統制群：通常のケアのみ（20名）
  - 結果：介入群の方が症状が改善
    - しかし，この差は単なる個人差による変動なのか？
    - それとも介入の効果と言えるのか？
  - → 統計的仮説検定で判断

## 統計的仮説検定の役割

### 観察された差が統計的に有意か判断する
- **事前に**定めた基準（有意水準）に基づいて判断を行う
  - データを見てから基準を変更しない
  - 恣意的な判断を防ぐ

### 重要性
- 再現性の確保
- 研究の信頼性向上

## 統計的仮説検定におけるエラー
1. **第1種の誤り (α)**
   - 実際には効果がないのに，誤って「効果がある」と判断するエラー
     - 帰無仮説が正しい場合に，帰無仮説を誤って棄却
     - 有意水準は通常5%と設定される

2. **第2種の誤り (β)**
   - 実際には効果があるのに，誤って「効果がない」と判断するエラー
     - 対立仮説が正しい場合に，対立仮説を誤って棄却
     - 検出力は1-βと表現される

## 再現性の危機
- 心理学研究の約40%が再現できない (Open Science Collaboration, 2015)

### 主な原因
1. **不適切な研究実践**
   - 事後的な分析方法の変更（HARKing）
   - 有意な結果のみが出版される傾向（出版バイアス）
   - *p* < .05を達成するための不正（p-hacking） 

2. **透明性の欠如**
   - 事前登録の不足
   - データ共有の不足
   - 分析コードの非公開

::: {.footer}
HARKing: Hypothesizing After the Results are Known
:::

## p-hacking
- データや分析方法を操作して，意図的に*p* < .05を達成すること
- 研究の信頼性を著しく損なう不適切な研究実践

### 具体例
1. **データの選択的除外**
   - 「外れ値」として都合の悪いデータを除外
   - 後出しで除外基準を変更

2. **変数の選択的報告**
   - 有意な結果が出た変数のみを報告
   - 複数の従属変数から都合の良いものを選択

3. **n増し問題**
   - 中間解析で有意でない場合，追加でデータを収集
   - *p*値が.05を下回るまでサンプルサイズを増やし続ける

## 事例：オルトメディコの「有意差保証プラン」
![有意差が出るまで繰り返す臨床試験サポートサービス](images/有意差保証.png)

## なぜ問題なのか？
1. **統計的な問題**
   - n増し問題による第1種の誤り率の増大
   - p-hackingの一形態

2. **倫理的な問題**
   - 研究の信頼性を損なう
   - 消費者を誤認させる可能性
   - 科学的な研究プロセスの歪曲

::: {.notes}
2023年3月に発表されたこのサービスは，研究者や業界関係者から強い批判を受けました。
科学的な研究手法の基本原則に反する事例として注目されています。
:::

## HARKingの例：非劣性検定への切り替え
  - オンラインCBTの効果検証（対面CBTより優れているという仮説）
  - 主要評価項目：CES-D得点の変化量

- 結果が期待通りでなかった場合...
  ```{r}
  #| echo: false
  #| fig-width: 8
  #| fig-height: 4
  library(ggplot2)
  
  # データフレームの作成
  df <- data.frame(
    group = c("対面CBT", "オンラインCBT"),
    mean = c(-5.2, -4.8),
    se = c(0.5, 0.5)
  )
  
  ggplot(df, aes(x = group, y = mean)) +
    geom_bar(stat = "identity", fill = "lightblue", width = 0.5) +
    geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +
    labs(title = "CES-D得点の変化量",
         x = "介入群",
         y = "得点の変化") +
    theme_minimal(base_family = "HiraginoSans-W3") +
    theme(
      plot.title = element_text(size = 16, face = "bold"),
      axis.title = element_text(size = 14),
      axis.text = element_text(size = 12)
    )
  ```

## 事後的な仮説変更-HARKing-
1. **当初の仮説**
   - オンラインCBTは対面CBTより効果が高い
   - 両側検定で計画（α = .05）

2. **結果を見てからの変更**
   - 「オンラインCBTは対面CBTと同等の効果がある」
   - 非劣性検定に切り替え

### 問題点
- 検定方法の事後的な変更
- 有意水準の実質的な操作
- 結果の解釈が恣意的


## 片側検定と両側検定
### 両側検定
- 対立仮説が，母数の値が「等しくない」ことを主張する場合に用いる
  - 例：母集団相関係数がゼロではない(*ρ* ≠ 0)
- 棄却域を分布の両側に設定

### 片側検定
- 対立仮説が，母数の値が「大きい」または「小さい」ことを主張する場合に用いる
  - 例：母集団相関係数がゼロより大きい(*ρ* > 0)，または母集団相関係数がゼロより小さい(*ρ* < 0)
- 棄却域を分布の片側に設定

::: {.footer}
実際の研究では両側検定を用いることが多い
:::

## 再現性問題への対策
- 事前登録の推進
- オープンデータ・オープンコードの推進
- サンプルサイズの適切な設計


## 事前登録による透明性の確保
1. **研究開始前に登録する内容**
   ```yaml
   主要評価項目: CES-D得点の変化
   解析方法: 混合モデル分散分析
   除外基準: 3回以上欠席した参加者
   サンプルサイズ: 各群30名
   検出力: .80 (効果量 d = 0.50)
   ```

2. **透明性が高まる理由**
   - 分析方法の事前確定
   - 結果の選択的報告を防止
   - サンプルサイズの事前確定

::: {.footer}
事前登録されてるだけで信頼性が上がる
:::

## 事前登録による透明性の確保
![](images/事前登録した内容.png)

## 事前登録の重要な要素
1. **時系列的な記録**
   - 研究開始前の登録（2022/04/28）
   - 進捗状況の定期的な更新
   - 結果公開までの追跡（2024/02）

2. **透明性の確保**
   - プロトコルの事前確定
   - 参加者数の記録
   - 結果公開状況の管理

::: {.footer}
UMIN臨床試験登録システムでの登録例（UMIN000047621）
:::

::: {.notes}
- UMINでの事前登録により，研究計画から結果報告まで一貫した記録が残されています
- 更新履歴が明確に記録され，研究の透明性が確保されています
- 事後的な分析方法の変更や選択的報告を防ぐことができます
:::

## 事前登録プラットフォーム：OSF

![](images/OSF.png)

## 検出力

- 定義：母集団に実際に効果がある場合に，それを検出できる確率
  - 帰無仮説を正しく棄却できる確率
  - 第2種の誤り（β）を犯さない確率（1-β）

::: {.footer}
検出力は検定力とも呼ばれるがこの資料では検出力で統一する
:::

::: {.notes}
前節で述べたように，相関係数に関する帰無仮説の検定は，相関関係について議論する際の前提として，得られた結果が帰無仮説のもとでは生じにくいものであること，すなわち有意であることを確認する目的で行われます。このことは，相関係数の検定だけでなく，第6章で紹介する平均値差や比率差に関する検定についても，一般的に言えることです。したがって，研究においては，その前提が満たされるように，すなわち有意な結果が得られるようにサンプルサイズなどの計画を立てることが望ましいということになります。

一方，たとえば母集団相関係数が ρ＝.1 のように非常に低い値のものでしたら，これを検出することができなくても，つまり，有意な結果が得られなくても，研究上，特に不都合はありません。すなわち，どんな場合でも常に有意な結果が得られることが望ましいというのではなく，「母集団において無視できない程度の相関があるのなら，それを検出できること」，つまり，有意な結果が得られることが望ましい」ということです。

母集団においてゼロでない相関（あるいは問題によっては平均値差など）があるとき，サンプルにおいて有意な結果が得られる確率のことを**検定力（power）**とよびます。また，母集団に存在する相関や平均値差を正しく検出できる確率という意味で検出力ともよばれます。
:::


## ネイマン＝ピアソン理論
### 概要
- 統計的仮説検定の基礎となる理論
- 2つの仮説（帰無仮説と対立仮説）の間で判断を行う
- 最適な検定方法を数学的に定式化

### 実践的意義
- 客観的な判断基準の提供
- 検定の誤りを定量的に評価可能
- サンプルサイズ設計の理論的基盤

::: {.footer}
Neyman & Pearson (1933) に基づく統計的仮説検定の枠組み
:::

:::{.notes}
ここでネイマン＝ピアソン理論について簡単に説明します。
ネイマン＝ピアソン理論は，統計的検定における誤りの型（タイプIエラーとタイプIIエラー）を区別し，それらの誤りを最小限に抑える検定設計を提唱します。この理論では，事前にαとβを設定し，それに基づいてサンプルサイズを決定することで精度の高い仮説検定を実現します。言い換えると，検出分析を行い，適切なサンプルサイズを設計することが重要であるという理論です。
:::

## 検出力分析によるサンプルサイズ設計

::: {.columns}

::: {.column width="50%"}
### 概要
- 適切なサンプルサイズ設計のための手法
- 4つの要素の関係性を考慮:
  1. サンプルサイズ (n)
  2. 効果量 (effect size)
  3. 有意水準 (α)
  4. 検出力 (1-β)
:::

::: {.column width="50%"}
### 意義
- 過剰なサンプルサイズを防ぐ
  - 研究資源の効率的な活用
  - 倫理的配慮
- 検出力不足を防ぐ
  - 効果の見逃しを防止
  - 研究の信頼性向上
:::

:::

::: {.footer}
4つの要素のうち3つを固定すると，残り1つが決定される
:::

::: {.notes}
検出力分析は，サンプルサイズ，効果量（effect size），有意水準（α），および検出力の4つの要素の関係を明らかにし，これらを基に適切なサンプルサイズを決定する手法です。この分析を行うことで，必要以上に大きなサンプルサイズを用意することを避けると同時に，サンプルサイズ不足によって効果を見逃すリスクも防ぐことができます。
:::

## サンプルサイズ設計の実例
:::: {.columns}

::: {.column width="60%"}
- 想定する効果量：完遂率20%の改善
  - 先行研究ではチャットボットの使用で20%の改善
- 統計的検出力分析
  - α = .05（両側検定）
  - 検出力 = 80%
  - 必要サンプルサイズ：124名
- 実際の募集人数：150名
  - オリエンテーション不参加や参加辞退を考慮
  - 脱落率20%を想定
:::

::: {.column width="40%"}
![](images/サンプルサイズの根拠の実例.png)
:::

::::

::: {.footer}
[Yasukawa et al. (2024). BMJ Mental Health](https://doi.org/10.1136/bmjment-2023-300881)
:::

::: {.notes}
- サンプルサイズは事前の検出力分析に基づいて決定
- 予想される脱落率も考慮して余裕を持った募集計画
- 透明性の高い研究デザインの例として参考になる
:::

# 演習2 {background="#43464B"}
サンプルサイズの設計

:::{.notes}
それでは，実際にサンプルサイズ設計を行ってみましょう。
演習2では演習1の結果を基に，同様の効果を再現できるかを確認するために，サンプルサイズの設計を行います。
:::

## 演習1の結果の振り返り
- AHIとCES-Dの相関分析結果：
  - 相関係数: *r* = -.73
  - 強い負の相関が確認された
  - 統計的に有意 (*p* < .001)

## 追試研究の計画
1. **目的**
    - 先行研究の結果を追試研究により再確認すること
2. **検定方法**
    - **検定**：無相関検定（両側検定）
    - **帰無仮説**：母相関係数 *ρ*=0
    - **対立仮説**：母相関係数 *ρ*≠0
3. **検出力分析の設定**
    - **効果量**：*r*=0.73（先行研究と同程度の効果量を想定）
    - **有意水準**：*α*=.05（5%）
    - **検出力**：1−*β*=0.80（80%）

## 必要なサンプルサイズの算出
```{r power-analysis}
#| echo: true
library(pwr)# 要インストール
power_analysis <- pwr.r.test(　# 相関検定における検出力分析の関数
  r = 0.73,        # 演習1での効果量
  power = 0.80,    # 目標とする検出力
  sig.level = 0.05,# 有意水準
  alternative = "two.sided"  # 両側検定
)
print(power_analysis)　# 結果の表示
```

## 検出力分析の結果解釈
- 必要なサンプルサイズ：12名
  - 11.51を切り上げ
- 設定条件：
  - 効果量：*r* = 0.73（先行研究相当）
  - 有意水準：*α* = .05（5%）
  - 検出力：1-*β* = .80（80%）
  - 両側検定

::: {.footer}
4つの要素のうち3つを固定すると，残り1つが決定される
:::

:::{.notes}
「これで理論上のサンプルサイズ設計が完了しました。計算によれば，**サンプルサイズ12名**で，検出力80%（タイプIIエラーの確率20%）を達成できることが確認されました。」
:::

# サンプルサイズは本当に正しいのか？

## サンプルサイズの妥当性検証

::: {.columns}

- サンプルサイズ12名で検出力80%を達成
- 有意な相関を検出できる確率が80%
- 第二種の誤りの確率は20%
- 実際に母集団から12⼈サンプリングして無相関分析を何度も繰り返した場合，そのうち80％の標本相関が有意になる
:::

::: {.footer}
８割で有意な相関が検出できるはず
:::

:::{.notes}
「理論的には，このデータを母集団とした場合，12名を抽出して幸福感と抑うつ感の相関分析を行えば，**タイプIIエラーの確率を20%に抑えられ，80%の確率で有意な相関が検出される**はずです。」
ここで，**タイプIエラー（効果がないのに誤って効果があると判断するエラー）については考慮する必要がありません**。なぜなら，今回の母集団データではすでに強い負の相関があることが確認されているため,「**効果がない場合（帰無仮説が真の場合）**」という前提そのものが成り立たないからです。
具体的には，タイプIエラーは「効果がない状態で誤って効果があると判断する確率」であり，
「そこで，実際に12名を抽出して相関分析を行った場合，**本当に80%の確率で有意な相関を検出できるのか**をシミュレーションで確認してみましょう。このシミュレーションによって，理論的なサンプルサイズ設計が現実に即しているかどうかを検証します。」
:::

# シミュレーションでの検出力の確認

## シミュレーションの手順

::: {.columns}

1. **サンプリング**
   - 母集団から12名をランダム抽出
   - 置き換えなしの抽出を実施

2. **分析実行**
   - 相関分析の実施
   - *p*値の算出と有意性の判定

3. **繰り返し処理**
   - 上記を1000回繰り返し
   - 結果を記録・集計

4. **検出力の算出**
   - 有意な相関が検出された割合を計算
   - 理論値（80%）との比較
:::

::: {.footer}
シミュレーションによる検証で理論値の妥当性を確認
:::

## 実際にシミュレーションを実施

```{r simulation}
#| echo: true
#| eval: true 
num_simulations <- 10000  # シミュレーション回数
sample_size <- 12        # サンプルサイズ
significant_results <- 0 # 有意な結果のカウンター

# シミュレーションの実行
set.seed(2025)  # 再現性のために乱数シードを設定
for(i in 1:num_simulations) {
  # 12名をランダムに抽出
  sample_indices <- sample(nrow(baseline_data), sample_size)
  sample_data <- baseline_data[sample_indices, ]
  
  # 相関分析の実行
  test_result <- cor.test(
    sample_data$ahiTotal, 
    sample_data$cesdTotal,
    method = "pearson"
  )
  
  # 有意な結果（p < .05）をカウント
  if(test_result$p.value < 0.05) {
    significant_results <- significant_results + 1
  }
}

# 検出力（有意な結果の割合）の計算
empirical_power <- significant_results / num_simulations
print(paste("シミュレーションによる検出力:", 
            round(empirical_power, 3)))  # 小数点以下3桁で丸めて表示
```
::: {.notes}
シード値（set.seedの値）とは，乱数生成の開始点を指定する値です。コンピュータの乱数は実は「疑似乱数」で，シード値が同じなら同じ順序で数値が生成されます。これにより，誰が実行しても同じ結果が得られる「再現性」が確保されます。

今回のシミュレーションでは，シード値を変えて複数回試してみても（例：set.seed(456)で87.9%，set.seed(789)で88.5%など），検出力は概ね87-89%の範囲に収まります。これは結果が偶然ではなく，安定した検出力を示していることを意味します。理論値の80%を一貫して上回る結果が得られることから，サンプルサイズ12名での検定は十分な検出力を持っていると判断できます。
:::

## 実際の研究とシミュレーションの違い
### 1. 効果量の不確実性
- 先行研究と同じ効果量が得られるとは限らない
- 変動要因：研究条件の違い，サンプル特性の違い，測定誤差の影響
- 追試研究では保守的なサンプルサイズ設定を推奨

### 2. 母集団の問題
- 実際の研究では：
  - 母集団が明確でない場合がある
  - サブグループに偏りがある可能性
  - 完全な無作為抽出は困難

:::{.notes}
「今回の演習では，シュミレーションを使い，理論上のサンプルサイズや検出力を確認しました。しかし，実際の研究では，以下のような追加的な考慮点が生じることに注意が必要です。」

1. **効果量の不確実性**
    - 先行研究と同じ効果量（r=0.73）が本当に得られるとは限らない。効果量は研究条件，サンプル特性，測定誤差などにより変動する。特に追試研究では，「効果量が先行研究よりも小さい可能性」も想定した保守的なサンプルサイズ設定が推奨される。
2. **対象者の募集やドロップアウトの問題**
    - シミュレーションではサンプルを無作為に抽出する前提としていたが，現実の研究では，対象者募集の難しさや，実験への協力拒否・ドロップアウトなどのリスクがある。そのため，研究の途中で予定したサンプルサイズを確保できないケースも想定し，余裕をもった募集計画を立てることが重要。
3. **母集団の定義と代表性**
    - シミュレーションでは「母集団からの無作為抽出」を行ったが，実際の研究がターゲットとする母集団が明確でない場合や，母集団のサブグループが偏っている場合もある。
:::


# 課題 {background="#43464B"}
時点別の相関分析と検出力分析

## 課題の概要
### 目的
- 複数時点における抑うつと幸福感の相関を検定
- それぞれの相関係数から追試に必要なサンプルサイズを算出

### 分析対象
- Woodworth et al. (2018)のデータ（ahi-cesd.csv）
- ベースライン時点を除く5時点

## 課題の具体的内容 {.smaller}

::: {.columns}

::: {.column width="50%"}
### 1. 相関分析

以下の各時点で95%と99%の信頼区間を算出：

- 介入直後 (時点1)
- 1週間後 (時点2)
- 1ヶ月後 (時点3)
- 3ヶ月後 (時点4)
- 6ヶ月後 (時点5)
:::

::: {.column width="50%"}
### 2. 検出力分析
- 各時点の相関係数を用いて
- 必要サンプルサイズを算出
- 設定条件：
  - 有意水準：α = .05
  - 検出力：1-β = .80
:::

:::

## 提出方法
1. 各時点での95%と99%の信頼区間を報告
2. 各時点での相関係数から必要サンプルサイズを報告

::: {.footer}
ベースライン時の分析（r = -.73）のコードを参考にしてください
:::

## 参考文献 {background-color="#f5f5f5"}

::: {.columns}
::: {.column width="50%"}
### オンライン資料
![](images/lovehico.png)

[Quartoによるスライド作成](https://ykunisato.github.io/ccp-lab-slide/tws-quarto-2023/slide.html#/title-slide)


:::

::: {.column width="50%"}
### 書籍
![数値シミュレーションで読み解く統計のしくみ](images/数値シミュレーションで読み解く統計の仕組み.jpg)

[数値シミュレーションで読み解く統計のしくみ〜Rでためしてわかる心理統計](https://gihyo.jp/book/2023/978-4-297-13665-9)

:::
:::

::: {.footer}
お疲れ様でした
:::